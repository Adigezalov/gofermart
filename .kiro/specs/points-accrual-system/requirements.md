# Requirements Document

## Introduction

Система начисления баллов лояльности для Гофермарт - это функциональность, которая позволяет пользователям накапливать баллы за заказы и тратить их на новые покупки. Система интегрируется с внешним сервисом расчета баллов и предоставляет API для управления балансом пользователей.

## Requirements

### Requirement 1

**User Story:** Как пользователь системы, я хочу видеть свой текущий баланс баллов лояльности, чтобы знать, сколько баллов у меня доступно для трат.

#### Acceptance Criteria

1. WHEN пользователь делает GET запрос на `/api/user/balance` с валидным токеном авторизации THEN система SHALL вернуть статус 200 и JSON с полями `current` (текущий баланс) и `withdrawn` (потрачено за все время)
2. WHEN пользователь делает запрос без токена авторизации THEN система SHALL вернуть статус 401
3. WHEN происходит внутренняя ошибка сервера THEN система SHALL вернуть статус 500

### Requirement 2

**User Story:** Как пользователь системы, я хочу списывать баллы лояльности для оплаты новых заказов, чтобы получить скидку на покупки.

#### Acceptance Criteria

1. WHEN пользователь делает POST запрос на `/api/user/balance/withdraw` с валидным токеном, номером заказа и суммой списания THEN система SHALL проверить достаточность средств и списать баллы, вернув статус 200
2. WHEN у пользователя недостаточно баллов для списания THEN система SHALL вернуть статус 402
3. WHEN номер заказа не проходит валидацию по алгоритму Луна THEN система SHALL вернуть статус 422
4. WHEN пользователь не авторизован THEN система SHALL вернуть статус 401
5. WHEN происходит внутренняя ошибка THEN система SHALL вернуть статус 500

### Requirement 3

**User Story:** Как пользователь системы, я хочу видеть историю своих списаний баллов, чтобы отслеживать свои траты.

#### Acceptance Criteria

1. WHEN пользователь делает GET запрос на `/api/user/withdrawals` с валидным токеном THEN система SHALL вернуть статус 200 и JSON массив с историей списаний, отсортированной по времени от новых к старым
2. WHEN у пользователя нет списаний THEN система SHALL вернуть статус 204
3. WHEN пользователь не авторизован THEN система SHALL вернуть статус 401
4. WHEN происходит внутренняя ошибка THEN система SHALL вернуть статус 500

### Requirement 4

**User Story:** Как система, я хочу автоматически получать информацию о начислениях от внешнего сервиса расчета баллов, чтобы обновлять статусы заказов и начислять баллы пользователям.

#### Acceptance Criteria

1. WHEN заказ имеет статус NEW или PROCESSING THEN система SHALL периодически запрашивать информацию о начислении у внешнего сервиса
2. WHEN внешний сервис возвращает статус PROCESSED с суммой начисления THEN система SHALL обновить статус заказа и начислить баллы на счет пользователя
3. WHEN внешний сервис возвращает статус INVALID THEN система SHALL обновить статус заказа на INVALID без начисления баллов
4. WHEN внешний сервис возвращает 429 (Too Many Requests) THEN система SHALL соблюдать Retry-After заголовок и повторить запрос позже
5. WHEN внешний сервис недоступен THEN система SHALL повторить запрос с экспоненциальной задержкой

### Requirement 5

**User Story:** Как администратор системы, я хочу, чтобы система корректно обрабатывала балансы пользователей при всех операциях, чтобы обеспечить целостность данных.

#### Acceptance Criteria

1. WHEN пользователю начисляются баллы THEN система SHALL атомарно увеличить текущий баланс пользователя
2. WHEN пользователь списывает баллы THEN система SHALL атомарно уменьшить текущий баланс и увеличить счетчик потраченных баллов
3. WHEN происходит конкурентное обновление баланса THEN система SHALL использовать транзакции базы данных для предотвращения race conditions
4. WHEN система запускается THEN она SHALL создать необходимые таблицы для хранения балансов и транзакций списания

### Requirement 6

**User Story:** Как разработчик, я хочу, чтобы система была настраиваемой через переменные окружения, чтобы легко деплоить ее в разных средах.

#### Acceptance Criteria

1. WHEN система запускается THEN она SHALL читать адрес внешнего сервиса начислений из переменной окружения `ACCRUAL_SYSTEM_ADDRESS` или флага `-r`
2. WHEN адрес не указан THEN система SHALL использовать значение по умолчанию `http://localhost:8081`
3. WHEN система не может подключиться к внешнему сервису THEN она SHALL логировать ошибку но продолжать работу